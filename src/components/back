<template>
    <div>
        <span v-if="edit" ref="editBox"></span>
        <span v-if="!edit">{{currentValue}}<button @click="toggleEdit">编辑</button></span>
    </div>
</template>
<script type="text/jsx">
    import Vue from 'vue'
    export default {
        name:'tableInput',
        data(){
            return {
                edit:false,
                currentValue:this.getValue(this.value)
            }
        },
        props:['value','type','map','name','index'],
        methods:{
            handleKeyUp(event){
                if(event.keyCode === 13){
                    this.submitEdit(event)
                }
            },
            handleInputChange(event){
                this.currentValue = event.target.value
            },
            toggleEdit(){
                this.edit = !this.edit
            },
            submitEdit(event){
                this.toggleEdit();
                this.currentValue = this.getValue(event.target.value);
                this.$emit('edit',{
                    value:this.currentValue,
                    key:this.name,
                    index:this.index
                })
            },
            getValue(val){
                if(this.type === 'select'){
                    return this.map[val]
                }
                return val
            }
        },
        watch:{
            edit(val){
                if(val){
                    const self = this;
                    this.$nextTick(()=>{
                        this.editVm = new Vue({
                            render (h) {
                                let input;
                                if(self.type==='input'){
                                    input = (<input ref="input" value={self.currentValue}  onKeyup={self.handleKeyUp}/>)
                                }else if(self.type==='select'){
                                    input = (<select value={self.currentValue} onChange={self.submitEdit}>
                                        {Object.keys(self.map).map(key=>(<option value={key}>{self.map[key]}</option>))}
                                    </select>)
                                }
                                return input
                            },
                            destroyed(){
                                this.$el.parentNode.removeChild(this.$el)
                            },
                            mounted(){
                                if(self.type == 'input'){
                                    this.$nextTick(()=>{
                                        const input = this.$refs.input;
                                        input.focus();
                                        input.selectionStart = input.selectionEnd = input.value.length
                                    })
                                }
                            }
                        });
                        this.editVm.$mount(this.$refs.editBox)
                    })
                }else {
                    if(this.editVm){
                        this.editVm.$destroy();
                        this.editVm = null
                    }
                }
            }
        }
    }
</script>

